<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ADH Simulator</title>
  <style>
    body {
      background-color: #2d2d2d;
      color: #fefefe;
      font-family: 'Chalkboard', 'Comic Sans MS', cursive;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    h1, h2 {
      font-size: 2em;
      margin: 80px 0 20px 0;
    }
    canvas {
      background-color: transparent;
      width: 80%;
      max-width: 800px;
      aspect-ratio: 16 / 9;
      margin: 20px auto;
      display: block;
      border: 4px solid #fff;
      box-shadow: 0 0 20px rgba(255,255,255,0.3);
    }
    button {
      background-color: #444;
      color: #fff;
      border: 2px solid #fff;
      padding: 10px 20px;
      margin: 10px;
      cursor: pointer;
      font-size: 1em;
      font-family: 'Chalkboard', 'Comic Sans MS', cursive;
    }
    button:hover {
      background-color: #666;
    }
    #popup {
  background-color: rgba(0,0,0,0.8);
  color: #fff;
  position: fixed;
  top: 16%;         /* was 20%, moves it higher */
  right: 5%;
  padding: 15px;    /* slightly smaller padding */
  border: 3px solid #fff;
  width: 280px;     /* slightly narrower */
  display: none;
  z-index: 10;
  text-align: left;
  font-size: 0.95em; /* optional: makes text fit better */
}

    input[type=range] {
      width: 80%;
      max-width: 800px;
      margin: 10px auto;
      display: block;
    }
  </style>
</head>
<body>
  <h1>What happens to ADH usually when we drink too much water?</h1>
  <canvas id="canvas" width="800" height="450"></canvas>
  <button id="playButton">Pour a liter of water to see how the body should respond</button>

  <div id="popup">
    <p id="popupText">What do you think will happen to the urine osmolarity and urine sodium?</p>
    <button id="findOut">Find Out</button>
  </div>

  <h2>So what would happen if I kept the ADH system on while I poured water?</h2>
  <canvas id="canvas2" width="800" height="450"></canvas>
  <input type="range" id="scrubber" min="1" max="84" value="1">
  <div>
    <button id="increaseADH">Increase ADH and add water</button>
    <button id="decreaseADH">Decrease ADH and excrete water</button>
    <button id="pauseADH">Pause</button>
  </div>

  <script>
// === First Animation (ADHlow) ===
const adhlowFrames = [];
const adhlowTotal = 84;
for (let i = 1; i <= adhlowTotal; i++) {
  const num = String(i).padStart(5, '0');
  adhlowFrames.push(`adhlow/frame_${num}.png`);
}

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let currentFrame = 0;
let playing = false;
let pausedAt44 = false;
let questionAskedOnce = false; // track if the question was asked already
// Draw the first frame of ADHlow on load
drawFrame(0);

function drawFrame(index) {
  const img = new Image();
  img.src = adhlowFrames[index];
  img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
}

const fps = 8; // adjust playback speed
const frameDuration = 1000 / fps;
let lastTime = 0;

function playAnimation() {
  if (playing) return;
  playing = true;
  currentFrame = 0;
  pausedAt44 = false;
  lastTime = 0;
  run();
}

function run(timestamp) {
  if (!lastTime) lastTime = timestamp;
  const delta = timestamp - lastTime;

  if (delta >= frameDuration) {
    drawFrame(currentFrame);

    if (currentFrame === 43 && !pausedAt44) {
      pausedAt44 = true;
      playing = false;

      const popup = document.getElementById('popup');
      const findOutButton = document.getElementById('findOut');

      // Change button text depending on whether this is the first time
      if (!questionAskedOnce) {
        popup.style.display = 'block';
        findOutButton.textContent = 'Find Out';
      } else {
        popup.style.display = 'block';
        findOutButton.textContent = 'Resume';
      }

      lastTime = 0;
      return;
    }

    currentFrame++;
    lastTime = timestamp;
  }

  if (currentFrame < adhlowTotal && playing) {
    requestAnimationFrame(run);
  } else if (currentFrame >= adhlowTotal) {
    playing = false;
    lastTime = 0;
  }
} // <-- this closes the run() function

document.getElementById('playButton').addEventListener('click', playAnimation);

document.getElementById('findOut').addEventListener('click', () => {
  questionAskedOnce = true; // mark that the question has been asked once

  document.getElementById('popupText').innerHTML = `
    <p>ADH drops to excrete excess free water, urine becomes dilute so both osmolarity and urine sodium drop.</p>
    <p>You can still become hyponatremic even with a suppressed ADH if your water intake exceeds your output. This can happen if:</p>
    <ol style="margin-left: 1em;">
      <li>You drink a truly excessive amount (polydipsia).</li><br>
      <li>You don't have enough solute to excrete all the water.</li><br>
      <li>You have kidneys with poor max diluting capacity.</li>
    </ol>
    <p>Because ADH is already low in these states with urine osm &lt; 200, these patients can rapidly excrete water and overcorrect once they stop drinking water or get enough solute.</p>
  `;

  const findOutButton = document.getElementById('findOut');
  findOutButton.textContent = 'Resume';
  findOutButton.onclick = () => {
    document.getElementById('popup').style.display = 'none';
    playing = true;
    run();
  };
});




  // === Second Animation (ADH + REVERSEADH) ===
  const adhFrames = [];
  const adhTotal = 84;
  for (let i = 1; i <= adhTotal; i++) {
    const num = String(i).padStart(5, '0');
    adhFrames.push(`ADH/frame_${num}.png`);
  }

  const reverseFrames = [];
  const reverseTotal = 75;
  for (let i = 1; i <= reverseTotal; i++) {
    const num = String(i).padStart(5, '0');
    reverseFrames.push(`REVERSEADH/frame_${num}.png`);
  }

  const canvas2 = document.getElementById('canvas2');
  const ctx2 = canvas2.getContext('2d');
  let currentFrame2 = 0;
  let adhPlaying = false;
  let adhDirection = 1;
  let usingReverse = false;

  const fps2 = 8; // adjust speed of second animation
  const frameDuration2 = 1000 / fps2;
  let lastTime2 = 0;

  function drawFrame2(index, reverse = false) {
    const img = new Image();
    img.src = reverse ? reverseFrames[index] : adhFrames[index];
    img.onload = () => ctx2.drawImage(img, 0, 0, canvas2.width, canvas2.height);
  }

  function runADH(timestamp) {
    if (!adhPlaying) return;
    if (!lastTime2) lastTime2 = timestamp;
    const delta = timestamp - lastTime2;

    if (delta >= frameDuration2) {
      if (!usingReverse) {
        drawFrame2(currentFrame2);
        currentFrame2 += adhDirection;
        lastTime2 = timestamp;

        if (adhDirection === 1 && currentFrame2 < adhTotal) {
          requestAnimationFrame(runADH);
        } else if (adhDirection === -1 && currentFrame2 > 54) {
          requestAnimationFrame(runADH);
        } else if (adhDirection === -1 && currentFrame2 <= 54) {
          usingReverse = true;
          currentFrame2 = 40; // index for REVERSEADH
          requestAnimationFrame(runADH);
        } else {
          adhPlaying = false;
          lastTime2 = 0;
        }
      } else {
        drawFrame2(currentFrame2, true);
        currentFrame2--;
        lastTime2 = timestamp;

        if (currentFrame2 >= 0) {
          requestAnimationFrame(runADH);
        } else {
          adhPlaying = false;
          usingReverse = false;
          lastTime2 = 0;
        }
      }
    } else {
      requestAnimationFrame(runADH);
    }

    document.getElementById('scrubber').value = currentFrame2 + 1;
  }

  document.getElementById('increaseADH').addEventListener('click', () => {
    adhPlaying = true;
    adhDirection = 1;
    usingReverse = false;
    currentFrame2 = 0;
    lastTime2 = 0;
    runADH();
  });

  document.getElementById('decreaseADH').addEventListener('click', () => {
    adhPlaying = true;
    adhDirection = -1;
    usingReverse = false;
    currentFrame2 = parseInt(document.getElementById('scrubber').value) - 1;
    lastTime2 = 0;
    runADH();
  });

  document.getElementById('pauseADH').addEventListener('click', () => {
    adhPlaying = false;
  });

  const scrubber = document.getElementById('scrubber');
  scrubber.addEventListener('input', () => {
    adhPlaying = false;
    usingReverse = false;
    currentFrame2 = parseInt(scrubber.value) - 1;
    drawFrame2(currentFrame2);
  });

  // Draw first frame of ADH on load
  drawFrame2(0);
</script>

</body>
</html>
