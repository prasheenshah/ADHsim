<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css2?family=Gloria+Hallelujah&display=swap" rel="stylesheet">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ADH Simulator</title>
  <style>
    body {
      background-color: #2d2d2d;
      color: #fefefe;
      font-family: 'Chalkboard', 'Comic Sans MS', cursive;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    h1, h2 {
      font-size: 2em;
      margin: 80px 0 20px 0;
  font-family: 'Gloria Hallelujah', cursive;
}
    canvas {
      background-color: transparent;
      width: 80%;
      max-width: 800px;
      aspect-ratio: 16 / 9;
      margin: 20px auto;
      display: block;
      border: 4px solid #fff;
      box-shadow: 0 0 20px rgba(255,255,255,0.3);
    }
    button {
      background-color: #444;
      color: #fff;
      border: 2px solid #fff;
      padding: 10px 20px;
      margin: 10px;
      cursor: pointer;
      font-size: 1em;
      font-family: 'Chalkboard', 'Comic Sans MS', cursive;
    }
    button:hover {
      background-color: #666;
    }
    #popup {
  background-color: rgba(0,0,0,0.8);
  color: #fff;
  position: fixed;
  top: 17%;         /* was 20%, moves it higher */
  right: 5%;
  padding: 15px;    /* slightly smaller padding */
  border: 3px solid #fff;
  width: 280px;     /* slightly narrower */
  display: none;
  z-index: 10;
  text-align: left;
  font-size: 0.95em; /* optional: makes text fit better */
}

    input[type=range] {
      width: 80%;
      max-width: 800px;
      margin: 10px auto;
      display: block;
    }
  </style>
</head>
<body>
  <h1>What happens to ADH usually when we drink too much water?</h1>
  <canvas id="canvas" width="800" height="450"></canvas>
  <button id="playButton">Pour a liter of water to see how the body should respond</button>

  <div id="popup">
    <p id="popupText">What do you think will happen to the urine osmolarity and urine sodium?</p>
    <button id="findOut">Find Out</button>
  </div>

  <h2>So what would happen if I kept the ADH system on while I poured water?</h2>
  <canvas id="canvas2" width="800" height="450"></canvas>
  <input type="range" id="scrubber" min="1" max="84" value="1">
  <div>
    <button id="increaseADH">Increase ADH and add water</button>
    <button id="decreaseADH">Decrease ADH and excrete water</button>
    <button id="pauseADH">Pause</button>
  </div>

  <script>
// === First Animation (ADHlow) ===
const adhlowFrames = [];
const adhlowTotal = 84;
for (let i = 1; i <= adhlowTotal; i++) {
  const num = String(i).padStart(5, '0');
  adhlowFrames.push(`adhlow/frame_${num}.png`);
}

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let currentFrame = 0;
let playing = false;
let pausedAt44 = false;

function drawFrame(index) {
  const img = new Image();
  img.src = adhlowFrames[index];
  img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
}

const fps = 8;
const frameDuration = 1000 / fps;
let lastTime = 0;

// Draw the first frame on page load
drawFrame(0);

function playAnimation() {
  if (playing) return;
  playing = true;
  currentFrame = 0;
  pausedAt44 = false;
  lastTime = 0;
  run();
}

function run(timestamp) {
  if (!lastTime) lastTime = timestamp;
  const delta = timestamp - lastTime;

  if (delta >= frameDuration) {
    drawFrame(currentFrame);

    // Pause at frame 43 and show the first popup
    if (currentFrame === 43 && !pausedAt44) {
      pausedAt44 = true;
      playing = false;

      const popup = document.getElementById('popup');
      const findOutButton = document.getElementById('findOut');

      document.getElementById('popupText').textContent =
        "What do you think will happen to the urine?";
      popup.style.display = 'block';
      findOutButton.textContent = 'Find Out';

      findOutButton.onclick = () => {
        document.getElementById('popupText').textContent =
          "ADH drops and the kidney excretes the excess free water. Urine becomes dilute so both osmolarity and urine sodium drop. Urine osmolarity is usually less than 200 but can get as low as 50, urine sodium is variable but is lower the more dilute the urine is";
        findOutButton.textContent = 'Resume';
        findOutButton.onclick = () => {
          document.getElementById('popup').style.display = 'none';
          playing = true;
          run();
        };
      };

      lastTime = 0;
      return;
    }

    currentFrame++;
    lastTime = timestamp;
  }

if (currentFrame < adhlowTotal && playing) {
  requestAnimationFrame(run);
} else if (currentFrame >= adhlowTotal) {
  playing = false;
  lastTime = 0;
  showSecondPopup();
}
}

document.getElementById('playButton').addEventListener('click', playAnimation);

// === Second popup at the end ===
function showSecondPopup() {
  const popup = document.getElementById('popup');
  const findOutButton = document.getElementById('findOut');

document.getElementById('popupText').textContent =
  "So how can you get hyponatremic even with a suppressed ADH and dilute urine?";
popup.style.display = 'block';
findOutButton.textContent = 'Learn More';


  findOutButton.onclick = () => {
    // Replace popup content once with the answer + buttons
    document.getElementById('popupText').innerHTML = `
      <p>You can still become hyponatremic even with a suppressed ADH if your water intake exceeds your output. This can happen if:</p>
      <ol style="margin-left: 1em;">
        <li>You drink a truly excessive amount (polydipsia).</li><br>
        <li>You don't have enough solute to excrete all the water.</li><br>
        <li>You have kidneys with poor max diluting capacity.</li>
      </ol>
      <p>Because ADH is already low in these states with urine osm &lt; 200, these patients can rapidly excrete water and overcorrect once they stop drinking water or get enough solute.</p>
      <div style="margin-top: 15px;">
        <button id="restartButton">Restart</button>
        <button id="closeButton">Close</button>
      </div>
    `;
    
findOutButton.style.display = 'none'; // Hide original Learn More button
    
    // Attach event listeners to the new buttons
    document.getElementById('restartButton').onclick = () => {
    document.getElementById('popup').style.display = 'none';
    findOutButton.style.display = 'inline-block'; // Restore for next time
    currentFrame = 0;
    playAnimation();
  };

  document.getElementById('closeButton').onclick = () => {
    document.getElementById('popup').style.display = 'none';
    findOutButton.style.display = 'inline-block'; 
    };
  };
}





  // === Second Animation (ADH + REVERSEADH) ===
// === Second Animation (ADH + REVERSEADH) ===
const adhFrames = [];
const adhTotal = 84;
for (let i = 1; i <= adhTotal; i++) {
  const num = String(i).padStart(5, '0');
  adhFrames.push(`ADH/frame_${num}.png`);
}

const reverseFrames = [];
const reverseTotal = 75;
for (let i = 1; i <= reverseTotal; i++) {
  const num = String(i).padStart(5, '0');
  reverseFrames.push(`REVERSEADH/frame_${num}.png`);
}

const canvas2 = document.getElementById('canvas2');
const ctx2 = canvas2.getContext('2d');
let currentFrame2 = 0;
let adhPlaying = false;
let adhDirection = 1; // 1 = forward, -1 = backward
let usingReverse = false;

// === Frame rate control ===
const fps2 = 8;
const frameDuration2 = 1000 / fps2;
let lastTime2 = 0;

function drawFrame2(index, reverse=false) {
  const img = new Image();
  img.src = reverse ? reverseFrames[index] : adhFrames[index];
  img.onload = () => ctx2.drawImage(img, 0, 0, canvas2.width, canvas2.height);
}

function runADH(timestamp) {
  if (!adhPlaying) return;

  if (!lastTime2) lastTime2 = timestamp;
  const delta = timestamp - lastTime2;

  if (delta >= frameDuration2) {
    lastTime2 = timestamp;

    if (!usingReverse) {
      drawFrame2(currentFrame2);

      // === Pause at frame 24 ===
      if (adhDirection === 1 && currentFrame2 === 24) {
        adhPlaying = false;

        const popup = document.getElementById('popup');
        const findOutButton = document.getElementById('findOut');

        document.getElementById('popupText').textContent =
          "ADH is up and the kidney is now actively reabsorbing water and concentrating the urine. What will happen when I keep adding water?";
        popup.style.display = 'block';
        popup.style.left = '5%';
        popup.style.right = 'auto';
        popup.style.top = '25%';

        findOutButton.textContent = 'Find Out';

        // First click = show answer
        findOutButton.onclick = function showAnswer() {
          document.getElementById('popupText').textContent =
            "Water intake exceeds water output, and the serum osmolarity and serum sodium start dropping as the extracellular fluid becomes more dilute.";

          findOutButton.textContent = 'Resume';

          // Second click = resume animation
          findOutButton.onclick = function resumePlay() {
            document.getElementById('popup').style.display = 'none';
            adhPlaying = true;
            runADH();
          };
        };

        return;
      }

      currentFrame2 += adhDirection;

      // === End of video pause ===
      if (adhDirection === 1 && currentFrame2 >= adhTotal) {
        adhPlaying = false;
        showFinalADHPopup();
        return;
      }

      if (adhDirection === -1 && currentFrame2 > 54) {
        requestAnimationFrame(runADH);
      } else if (adhDirection === -1 && currentFrame2 <= 54) {
        usingReverse = true;
        currentFrame2 = 40;
        requestAnimationFrame(runADH);
      } else if (adhDirection === 1 && currentFrame2 < adhTotal) {
        requestAnimationFrame(runADH);
      }
    } else {
      drawFrame2(currentFrame2, true);
      currentFrame2--;
      if (currentFrame2 >= 0) {
        requestAnimationFrame(runADH);
      } else {
        adhPlaying = false;
        usingReverse = false;
      }
    }

    document.getElementById('scrubber').value = currentFrame2 + 1;
  } else {
    requestAnimationFrame(runADH);
  }
}

// === Final popup ===
function showFinalADHPopup() {
  const popup = document.getElementById('popup');
  const findOutButton = document.getElementById('findOut');

  document.getElementById('popupText').textContent =
    "So why would my body keep ADH up to conserve water even though I am hyponatremic?";
  popup.style.display = 'block';
  popup.style.left = 'auto';
  popup.style.right = '5%';
  popup.style.top = '20%';

  findOutButton.textContent = 'Learn More';
  findOutButton.onclick = () => {
    document.getElementById('popupText').innerHTML = `
      <p>Ideally your ADH would be drop and your urine would be maximally dilute to excrete free water every time you get hyponatremic, like you saw in the last video. However, there are many other non osmotic stimuli for ADH that can override this need and keep the urine osmolarity &gt; 200 even when your sodium is dangerously low:</p>
      <ol style="margin-left: 1em;">
        <li><strong>Another powerful stimulus for ADH release is a decrease in blood pressure</strong> sensed by your baroreceptors, either from reduced cardiac output with hypervolemia, decompensated liver disease, or true hypovolemia. The key difference with conditions like this is that the body is also trying to conserve sodium and RAAS is up along with ADH. Unless the picture is muddied by diuretics, this means that your urine sodium will also be &lt; 25. These patients will have physical exam clues indicating too much or too little volume.</li><br>
        <li><strong>Sometimes, ADH will go up by itself without RAAS even with normal volume status</strong> because it is being secreted by a tumor or the patient is in pain, nauseous, or certain medications like SSRIs. This is called SIADH, and compared to the other causes above RAAS is not active and the body is not trying to conserve sodium so urine sodium is usually &gt; 40 and the patient is euvolemic.</li><br>
      </ol>
      <p>In most cases of heart/liver disease and cancer related SIADH, the ADH is chronically elevated and won't easily reverse so they may be harder to treat and don't tend to overcorrect. However, if the patient has a temporary reason to conserve water due to hypovolemia, ADH can rapidly drop after they have been resuscitated causing massive water excretion and overcorrection - similar to patients with low solute and primary polydipsia.</p>
      <div style="margin-top: 15px;">
        <button id="turnOffButton">Turn ADH Off</button>
        <button id="closeButton2">Close</button>
      </div>
    `;

    findOutButton.style.display = 'none';

    document.getElementById('turnOffButton').onclick = () => {
      document.getElementById('popup').style.display = 'none';
      findOutButton.style.display = 'inline-block';
      adhPlaying = true;
      adhDirection = -1;
      usingReverse = false;
      currentFrame2 = adhTotal - 1;
      runADH();
    };

    document.getElementById('closeButton2').onclick = () => {
      document.getElementById('popup').style.display = 'none';
      findOutButton.style.display = 'inline-block';
    };
  };
}

// === Buttons ===
document.getElementById('increaseADH').addEventListener('click', () => {
  adhPlaying = true;
  adhDirection = 1;
  usingReverse = false;
  currentFrame2 = 0;
  lastTime2 = 0;
  runADH();
});

document.getElementById('decreaseADH').addEventListener('click', () => {
  adhPlaying = true;
  adhDirection = -1;
  usingReverse = false;
  currentFrame2 = parseInt(document.getElementById('scrubber').value) - 1;
  lastTime2 = 0;
  runADH();
});

document.getElementById('pauseADH').addEventListener('click', () => {
  adhPlaying = false;
});

// Scrubber control
const scrubber = document.getElementById('scrubber');
scrubber.addEventListener('input', () => {
  adhPlaying = false;
  usingReverse = false;
  currentFrame2 = parseInt(scrubber.value) - 1;
  drawFrame2(currentFrame2);
});

// Draw first frame of ADH on load
drawFrame2(0);




</script>

</body>
</html>
